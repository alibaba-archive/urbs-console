## 产品

灰度系统的产品，仅以 name 标记，name 是系统内唯一，主要用于灰度配置隔离。比如一个灰度系统中可以包含 teambition、thoughts 等不同产品，每个产品有自己的灰度配置策略。

Urbs 支持两种灰度方式，标签的灰度和配置项的灰度。

### 环境标签

适用于 A/B Test 场景下，多套后端服务同时存在，根据灰度规则，选定用户范围，不同的用户组访问不同的后端。常用于测试新产品或新功能，一般分为两组用户，一组对照组，一组实验组。对照组采用已有的产品或功能，实验组采用新功能。根据用户反馈、数据指标，来逐步完善新功能。

在 Urbs 系统中的使用步骤：

1. 在管控后台产品下添加环境标签。
2. 部署一套对应环境标签下的后端服务。
3. Traefik 网关会把用户路由到环境标签所对应的服务。

### 功能模块&配置项

适用于前端某个功能灰度的场景。创建配置项后，可以发布标签到用户或群组上。前端通过 API 获取当前用户的配置项，根据配置项值来控制功能的灰度。

配置项的可选值是字符串格式，多个值用`,`分割，常见类型有：

- 开关类型："true","false"。
- 枚举类型："feature1","feature2","feature3"。

发布配置项时，可以选择具体的值，分配到用户或群组上。

配置项的端类型有 web、ios、android 三种，来控制当前配置项作用于哪个端。前端通过 API 获取配置项时，可指定端类型参数，来筛选本端的配置项。 比如移动端 ios 通过参数 client = ios，来获取本端的配置项。

## 用户范围

Urbs 支持用户、群组、访问用户百分比，来控制灰度用户范围。发布灰度时，选定的用户、群组必须在 Urbs 系统里存在。

添加用户、群组到 Urbs 系统的方式有：

- 少量用户和群组，可以在管控后台通过 UI 添加。
- 大量用户和群组，通过管控后台 API，批量添加。
- 增量用户和群组，通过定时同步、Webhook 、oplog / binlog 等方式监听已有用户系统的数据，同步到 Urbs 系统。

常见扩散灰度用户范围的步骤：

测试用户 -> 内部用户 -> 种子用户（特定用户） -> 活跃用户 -> 所有用户。

## 灰度方式

Urbs 支持的灰度方式：

1. 批量指定具体用户。

2. 批量指定群组，如 Teambition 的企业。
3. 按百分比灰度用户，这个是访问系统时被命中灰度的概率。比如配置 50%，那用户访问系统时会有 50% 的概率命中灰度，1 小时有 50w 访问系统，那大概有 25w 会命中灰度。命中灰度的用户下次访问还是处于灰度状态。

可扩展的灰度方式，需要使用方实现：

1. 按百分比或概率灰度新用户，比如在添加新用户到 Urbs 系统中，检查是否匹配自定义的规则，匹配则发布配置项或环境标签到该用户上。自定义规则可以按用户 ID 取余，按用户地域等。

## 回滚发布

Urbs 支持回滚已经发布的灰度，常见使用场景有：

一、误发布到错误的群组或用户

​        可在发布记录中撤回最新的发布。

二、某些群组、用户需要退出灰度

​        可在群组、用户里选择移除。

三、遇到重大问题、产品功能不达预期等

​        可在环境标签、配置项编辑页中选择下线。

## 通知机制

对于单页面的 Web 应用、移动端、PC 端来说，发布灰度或回滚灰度后，并不能及时通知前端，需要主动定时拉取新配置项才可以。

另一种方式是主动推送变化，Urbs 提供 hook 机制，使用者可以订阅配置项的变化，接收到事件后，利用已有的消息系统，推送给前端。

